#!/usr/bin/env bash
set -euo pipefail

# Hard Shell CLI
# Usage: hard-shell <command>
# Runs from the directory where this script lives (supports multiple instances).

# Resolve the real directory of this script (follows symlinks)
SCRIPT_PATH="$(cd "$(dirname "$0")" && pwd)"
INSTALL_DIR="${HARD_SHELL_DIR:-$SCRIPT_PATH}"

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

info()  { echo -e "${BLUE}[hard-shell]${NC} $*"; }
ok()    { echo -e "${GREEN}[hard-shell]${NC} $*"; }
fail()  { echo -e "${RED}[hard-shell]${NC} $*"; exit 1; }

# Map API key variable name to OpenClaw model identifier
model_for_provider() {
    case "$1" in
        ANTHROPIC_API_KEY) echo "anthropic:claude-sonnet-4-5-20250929" ;;
        OPENAI_API_KEY)    echo "openai:gpt-4o" ;;
        GOOGLE_API_KEY)    echo "google:gemini-2.0-flash" ;;
        XAI_API_KEY)       echo "xai:grok-3" ;;
        *)                 echo "" ;;
    esac
}

# Update model in data/openclaw/openclaw.json
update_openclaw_model() {
    local model="$1"
    local config_file="$INSTALL_DIR/data/openclaw/openclaw.json"
    if [ -f "$config_file" ] && command -v python3 &> /dev/null; then
        python3 -c "
import json
config_path = '$config_file'
model = '$model'
with open(config_path) as f:
    config = json.load(f)
config.setdefault('agents', {}).setdefault('defaults', {}).setdefault('model', {})['primary'] = model
with open(config_path, 'w') as f:
    json.dump(config, f, indent=2)
    f.write('\n')
" 2>/dev/null && info "Model set to: $model" || info "Could not update model config — restart will auto-detect."
    elif [ -f "$config_file" ]; then
        # Fallback: use sed if python3 not available
        sed -i.bak "s|\"primary\": \".*\"|\"primary\": \"$model\"|" "$config_file"
        rm -f "$config_file.bak"
        info "Model set to: $model"
    fi
}

if [ ! -d "$INSTALL_DIR" ]; then
    fail "Hard Shell not installed. Run: curl -fsSL https://raw.githubusercontent.com/gettweek/hard-shell/master/install.sh | bash"
fi

cmd="${1:-help}"

case "$cmd" in
    update)
        info "Pulling latest changes..."
        git -C "$INSTALL_DIR" pull --ff-only
        info "Rebuilding image..."
        docker compose -f "$INSTALL_DIR/docker-compose.yml" --env-file "$INSTALL_DIR/.env" build
        info "Restarting..."
        docker compose -f "$INSTALL_DIR/docker-compose.yml" --env-file "$INSTALL_DIR/.env" up -d
        ok "Updated and running."
        ;;
    start)
        info "Starting Hard Shell..."
        docker compose -f "$INSTALL_DIR/docker-compose.yml" --env-file "$INSTALL_DIR/.env" up -d
        ok "Started. Gateway: http://127.0.0.1:18789"
        ;;
    stop)
        info "Stopping Hard Shell..."
        docker compose -f "$INSTALL_DIR/docker-compose.yml" --env-file "$INSTALL_DIR/.env" down
        ok "Stopped."
        ;;
    restart)
        info "Restarting Hard Shell..."
        docker compose -f "$INSTALL_DIR/docker-compose.yml" --env-file "$INSTALL_DIR/.env" up -d --force-recreate
        ok "Restarted."
        ;;
    status)
        docker compose -f "$INSTALL_DIR/docker-compose.yml" --env-file "$INSTALL_DIR/.env" ps
        echo ""
        CONTAINER_ID=$(docker compose -f "$INSTALL_DIR/docker-compose.yml" --env-file "$INSTALL_DIR/.env" ps -q hard-shell 2>/dev/null || echo "")
        if [ -n "$CONTAINER_ID" ]; then
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' "$CONTAINER_ID" 2>/dev/null || echo "unknown")
            if [ "$STATUS" = "healthy" ]; then
                ok "Health: $STATUS"
            else
                info "Health: $STATUS"
            fi
        else
            info "Health: not running"
        fi
        ;;
    logs)
        docker compose -f "$INSTALL_DIR/docker-compose.yml" --env-file "$INSTALL_DIR/.env" logs "${@:2}"
        ;;
    preset)
        PRESET="${2:-}"
        if [ -z "$PRESET" ]; then
            CURRENT=$(grep "^TWEEK_PRESET=" "$INSTALL_DIR/.env" 2>/dev/null | cut -d= -f2 || echo "cautious")
            info "Current preset: $CURRENT"
            echo "  trusted   — Minimal scanning, fingerprint-based approval"
            echo "  cautious  — Balanced security with LLM review (default)"
            echo "  paranoid  — Maximum security, fail-closed"
            echo ""
            echo "Usage: hard-shell preset <name>"
        else
            case "$PRESET" in
                trusted|cautious|paranoid)
                    sed -i.bak "s/^TWEEK_PRESET=.*/TWEEK_PRESET=$PRESET/" "$INSTALL_DIR/.env"
                    rm -f "$INSTALL_DIR/.env.bak"
                    info "Preset changed to: $PRESET"
                    info "Run 'hard-shell restart' to apply."
                    ;;
                *)
                    fail "Unknown preset: $PRESET (valid: trusted, cautious, paranoid)"
                    ;;
            esac
        fi
        ;;
    apikey)
        echo ""
        echo "  1) Anthropic (Claude)"
        echo "  2) OpenAI (GPT-4)"
        echo "  3) Google (Gemini)"
        echo "  4) xAI (Grok)"
        echo ""
        echo -n "Choose your provider [1-4]: "
        read PROVIDER_CHOICE

        case "${PROVIDER_CHOICE:-}" in
            1) API_KEY_VAR="ANTHROPIC_API_KEY" ; info "Selected: Anthropic" ;;
            2) API_KEY_VAR="OPENAI_API_KEY"    ; info "Selected: OpenAI" ;;
            3) API_KEY_VAR="GOOGLE_API_KEY"    ; info "Selected: Google" ;;
            4) API_KEY_VAR="XAI_API_KEY"       ; info "Selected: xAI (Grok)" ;;
            *) fail "Invalid choice." ;;
        esac

        read -p "Paste your API key: " -r API_KEY_VALUE
        if [ -z "$API_KEY_VALUE" ]; then
            fail "No key entered."
        fi

        # Remove any existing key for this provider, then add the new one
        sed -i.bak "/^$API_KEY_VAR=/d" "$INSTALL_DIR/.env"
        rm -f "$INSTALL_DIR/.env.bak"
        echo "$API_KEY_VAR=$API_KEY_VALUE" >> "$INSTALL_DIR/.env"
        ok "API key saved."

        # Update OpenClaw model config to match the provider
        MODEL=$(model_for_provider "$API_KEY_VAR")
        if [ -n "$MODEL" ]; then
            update_openclaw_model "$MODEL"
        fi
        info "Run './hard-shell restart' to apply."
        ;;
    uninstall)
        # Resolve target: explicit path > current directory > script directory
        TARGET="${2:-}"
        if [ -n "$TARGET" ]; then
            TARGET="$(cd "$TARGET" 2>/dev/null && pwd)" || fail "Path not found: $2"
        elif [ -f "$(pwd)/docker-compose.yml" ] && [ -f "$(pwd)/.env" ]; then
            TARGET="$(pwd)"
        else
            TARGET="$INSTALL_DIR"
        fi

        if [ ! -f "$TARGET/docker-compose.yml" ]; then
            fail "No Hard Shell installation found at: $TARGET"
        fi

        echo -e "${RED}This will stop Hard Shell and remove $TARGET${NC}"
        read -p "Are you sure? (y/N) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            docker compose -f "$TARGET/docker-compose.yml" --env-file "$TARGET/.env" down 2>/dev/null || true
            docker rmi tweek/hard-shell:latest 2>/dev/null || true
            rm -rf "$TARGET"
            ok "Uninstalled."
        fi
        ;;
    help|--help|-h)
        echo "Hard Shell — Hardened OpenClaw + Tweek Security"
        echo ""
        echo "Usage: hard-shell <command>"
        echo ""
        echo "Commands:"
        echo "  start       Start the container"
        echo "  stop        Stop the container"
        echo "  restart     Restart the container"
        echo "  update      Pull latest code, rebuild, and restart"
        echo "  status      Show container health and status"
        echo "  logs        View container logs (pass -f to follow)"
        echo "  preset      View or change the security preset"
        echo "  apikey      Configure your LLM API key"
        echo "  uninstall   Remove Hard Shell (optional: path to instance)"
        echo "  help        Show this help"
        ;;
    *)
        fail "Unknown command: $cmd (run 'hard-shell help' for usage)"
        ;;
esac
