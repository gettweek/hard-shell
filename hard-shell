#!/usr/bin/env bash
set -euo pipefail

# Hard Shell CLI
# Usage: hard-shell <command>
# Runs from the directory where this script lives (supports multiple instances).

# Resolve the real directory of this script (follows symlinks)
SOURCE="$0"
while [ -L "$SOURCE" ]; do
    DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    # Handle relative symlinks
    [[ "$SOURCE" != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_PATH="$(cd "$(dirname "$SOURCE")" && pwd)"
INSTALL_DIR="${HARD_SHELL_DIR:-$SCRIPT_PATH}"

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

info()  { echo -e "${BLUE}[hard-shell]${NC} $*"; }
ok()    { echo -e "${GREEN}[hard-shell]${NC} $*"; }
fail()  { echo -e "${RED}[hard-shell]${NC} $*"; exit 1; }

# Map API key variable name to OpenClaw model identifier
model_for_provider() {
    case "$1" in
        ANTHROPIC_API_KEY) echo "anthropic/claude-sonnet-4-5-20250929" ;;
        OPENAI_API_KEY)    echo "openai/gpt-4o" ;;
        GOOGLE_API_KEY)    echo "google/gemini-2.0-flash" ;;
        XAI_API_KEY)       echo "xai/grok-3" ;;
        *)                 echo "" ;;
    esac
}

# Update model in data/openclaw/openclaw.json
update_openclaw_model() {
    local model="$1"
    local config_file="$INSTALL_DIR/data/openclaw/openclaw.json"
    if [ -f "$config_file" ] && command -v python3 &> /dev/null; then
        python3 -c "
import json
config_path = '$config_file'
model = '$model'
with open(config_path) as f:
    config = json.load(f)
config.setdefault('agents', {}).setdefault('defaults', {}).setdefault('model', {})['primary'] = model
with open(config_path, 'w') as f:
    json.dump(config, f, indent=2)
    f.write('\n')
" 2>/dev/null && info "Model set to: $model" || info "Could not update model config — restart will auto-detect."
    elif [ -f "$config_file" ]; then
        # Fallback: use sed if python3 not available
        sed -i.bak "s|\"primary\": \".*\"|\"primary\": \"$model\"|" "$config_file"
        rm -f "$config_file.bak"
        info "Model set to: $model"
    fi
}

# Build the tokenized gateway URL
gateway_url() {
    local token
    token=$(grep "^OPENCLAW_GATEWAY_TOKEN=" "$INSTALL_DIR/.env" 2>/dev/null | cut -d= -f2 || echo "")
    if [ -n "$token" ]; then
        echo "http://127.0.0.1:18789/?token=$token"
    else
        echo "http://127.0.0.1:18789"
    fi
}

if [ ! -d "$INSTALL_DIR" ]; then
    fail "Hard Shell not installed. Run: curl -fsSL https://raw.githubusercontent.com/gettweek/hard-shell/master/install.sh | bash"
fi

cmd="${1:-help}"

case "$cmd" in
    update)
        info "Pulling latest changes..."
        git -C "$INSTALL_DIR" pull --ff-only
        info "Rebuilding image..."
        docker compose -f "$INSTALL_DIR/docker-compose.yml" --env-file "$INSTALL_DIR/.env" build
        info "Restarting..."
        docker compose -f "$INSTALL_DIR/docker-compose.yml" --env-file "$INSTALL_DIR/.env" up -d
        ok "Updated and running. Gateway: $(gateway_url)"
        ;;
    start)
        info "Starting Hard Shell..."
        docker compose -f "$INSTALL_DIR/docker-compose.yml" --env-file "$INSTALL_DIR/.env" up -d
        ok "Started. Gateway: $(gateway_url)"
        ;;
    stop)
        info "Stopping Hard Shell..."
        docker compose -f "$INSTALL_DIR/docker-compose.yml" --env-file "$INSTALL_DIR/.env" down
        ok "Stopped."
        ;;
    restart)
        info "Restarting Hard Shell..."
        docker compose -f "$INSTALL_DIR/docker-compose.yml" --env-file "$INSTALL_DIR/.env" up -d --force-recreate
        ok "Restarted. Gateway: $(gateway_url)"
        ;;
    status)
        docker compose -f "$INSTALL_DIR/docker-compose.yml" --env-file "$INSTALL_DIR/.env" ps
        echo ""
        CONTAINER_ID=$(docker compose -f "$INSTALL_DIR/docker-compose.yml" --env-file "$INSTALL_DIR/.env" ps -q hard-shell 2>/dev/null || echo "")
        if [ -n "$CONTAINER_ID" ]; then
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' "$CONTAINER_ID" 2>/dev/null || echo "unknown")
            if [ "$STATUS" = "healthy" ]; then
                ok "Health: $STATUS"
            else
                info "Health: $STATUS"
            fi
        else
            info "Health: not running"
        fi
        ;;
    logs)
        LOG_SUB="${2:-}"
        LOG_DIR="$INSTALL_DIR/data/logs"
        case "$LOG_SUB" in
            app)
                if [ ! -f "$LOG_DIR/hard-shell.log" ]; then
                    fail "No app log found at $LOG_DIR/hard-shell.log"
                fi
                # Pass remaining args (e.g., -f for follow)
                if [[ "${3:-}" == "-f" ]]; then
                    tail -f "$LOG_DIR/hard-shell.log"
                else
                    tail -100 "$LOG_DIR/hard-shell.log"
                fi
                ;;
            audit)
                if [ ! -f "$LOG_DIR/audit.log" ]; then
                    fail "No audit log found at $LOG_DIR/audit.log"
                fi
                if [[ "${3:-}" == "-f" ]]; then
                    tail -f "$LOG_DIR/audit.log"
                else
                    tail -100 "$LOG_DIR/audit.log"
                fi
                ;;
            search)
                TERM="${3:-}"
                if [ -z "$TERM" ]; then
                    fail "Usage: hard-shell logs search <term>"
                fi
                if [ ! -d "$LOG_DIR" ]; then
                    fail "No log directory at $LOG_DIR"
                fi
                grep -rn "$TERM" "$LOG_DIR/" 2>/dev/null || info "No matches found for: $TERM"
                ;;
            stats)
                if [ ! -d "$LOG_DIR" ]; then
                    fail "No log directory at $LOG_DIR"
                fi
                echo "Log directory: $LOG_DIR"
                echo ""
                # File sizes
                for f in "$LOG_DIR"/*.log "$LOG_DIR"/*.log.*; do
                    if [ -f "$f" ]; then
                        SIZE=$(du -h "$f" 2>/dev/null | cut -f1)
                        echo "  $(basename "$f"): $SIZE"
                    fi
                done
                echo ""
                # Last startup time from app log
                if [ -f "$LOG_DIR/hard-shell.log" ]; then
                    LAST_READY=$(grep '"msg":"Hard Shell is running"' "$LOG_DIR/hard-shell.log" 2>/dev/null | tail -1)
                    if [ -n "$LAST_READY" ]; then
                        TOTAL_MS=$(echo "$LAST_READY" | grep -o '"total_ms":[0-9]*' | cut -d: -f2)
                        LAST_TS=$(echo "$LAST_READY" | grep -o '"ts":"[^"]*"' | cut -d'"' -f4)
                        echo "  Last startup: $LAST_TS (${TOTAL_MS}ms)"
                    fi
                fi
                # Recent errors
                if [ -f "$LOG_DIR/hard-shell.log" ]; then
                    ERROR_COUNT=$(grep -c '"level":"ERROR"' "$LOG_DIR/hard-shell.log" 2>/dev/null || echo "0")
                    WARN_COUNT=$(grep -c '"level":"WARN"' "$LOG_DIR/hard-shell.log" 2>/dev/null || echo "0")
                    echo "  Errors: $ERROR_COUNT  Warnings: $WARN_COUNT"
                fi
                # Audit event count
                if [ -f "$LOG_DIR/audit.log" ]; then
                    AUDIT_COUNT=$(wc -l < "$LOG_DIR/audit.log" 2>/dev/null || echo "0")
                    echo "  Audit events: $AUDIT_COUNT"
                fi
                ;;
            ""|"-f"|"--follow")
                # Default: docker compose logs (backwards compatible)
                docker compose -f "$INSTALL_DIR/docker-compose.yml" --env-file "$INSTALL_DIR/.env" logs "${@:2}"
                ;;
            *)
                # Pass through to docker compose logs (e.g., hard-shell logs --tail 50)
                docker compose -f "$INSTALL_DIR/docker-compose.yml" --env-file "$INSTALL_DIR/.env" logs "${@:2}"
                ;;
        esac
        ;;
    preset)
        PRESET="${2:-}"
        if [ -z "$PRESET" ]; then
            CURRENT=$(grep "^TWEEK_PRESET=" "$INSTALL_DIR/.env" 2>/dev/null | cut -d= -f2 || echo "cautious")
            info "Current preset: $CURRENT"
            echo "  trusted   — Minimal scanning, fingerprint-based approval"
            echo "  cautious  — Balanced security with LLM review (default)"
            echo "  paranoid  — Maximum security, fail-closed"
            echo ""
            echo "Usage: hard-shell preset <name>"
        else
            case "$PRESET" in
                trusted|cautious|paranoid)
                    sed -i.bak "s/^TWEEK_PRESET=.*/TWEEK_PRESET=$PRESET/" "$INSTALL_DIR/.env"
                    rm -f "$INSTALL_DIR/.env.bak"
                    info "Preset changed to: $PRESET"
                    info "Run 'hard-shell restart' to apply."
                    ;;
                *)
                    fail "Unknown preset: $PRESET (valid: trusted, cautious, paranoid)"
                    ;;
            esac
        fi
        ;;
    apikey)
        echo ""
        echo "  1) Anthropic (Claude)"
        echo "  2) OpenAI (GPT-4)"
        echo "  3) Google (Gemini)"
        echo "  4) xAI (Grok)"
        echo ""
        echo -n "Choose your provider [1-4]: "
        read PROVIDER_CHOICE

        case "${PROVIDER_CHOICE:-}" in
            1) API_KEY_VAR="ANTHROPIC_API_KEY" ; info "Selected: Anthropic" ;;
            2) API_KEY_VAR="OPENAI_API_KEY"    ; info "Selected: OpenAI" ;;
            3) API_KEY_VAR="GOOGLE_API_KEY"    ; info "Selected: Google" ;;
            4) API_KEY_VAR="XAI_API_KEY"       ; info "Selected: xAI (Grok)" ;;
            *) fail "Invalid choice." ;;
        esac

        read -p "Paste your API key: " -r API_KEY_VALUE
        if [ -z "$API_KEY_VALUE" ]; then
            fail "No key entered."
        fi

        # Remove any existing key for this provider, then add the new one
        sed -i.bak "/^$API_KEY_VAR=/d" "$INSTALL_DIR/.env"
        rm -f "$INSTALL_DIR/.env.bak"
        echo "$API_KEY_VAR=$API_KEY_VALUE" >> "$INSTALL_DIR/.env"
        ok "API key saved."

        # Update OpenClaw model config to match the provider
        MODEL=$(model_for_provider "$API_KEY_VAR")
        if [ -n "$MODEL" ]; then
            update_openclaw_model "$MODEL"
        fi
        info "Run './hard-shell restart' to apply."
        ;;
    url)
        echo "$(gateway_url)"
        ;;
    uninstall)
        # Resolve target: explicit path > current directory > script directory
        TARGET="${2:-}"
        if [ -n "$TARGET" ]; then
            TARGET="$(cd "$TARGET" 2>/dev/null && pwd)" || fail "Path not found: $2"
        elif [ -f "$(pwd)/docker-compose.yml" ] && [ -f "$(pwd)/.env" ]; then
            TARGET="$(pwd)"
        else
            TARGET="$INSTALL_DIR"
        fi

        if [ ! -f "$TARGET/docker-compose.yml" ]; then
            fail "No Hard Shell installation found at: $TARGET"
        fi

        echo -e "${RED}This will stop Hard Shell and remove $TARGET${NC}"
        read -p "Are you sure? (y/N) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            docker compose -f "$TARGET/docker-compose.yml" --env-file "$TARGET/.env" down 2>/dev/null || true
            docker rmi tweek/hard-shell:latest 2>/dev/null || true
            rm -rf "$TARGET"
            ok "Uninstalled."
        fi
        ;;
    help|--help|-h)
        echo "Hard Shell — Hardened OpenClaw + Tweek Security"
        echo ""
        echo "Usage: hard-shell <command>"
        echo ""
        echo "Commands:"
        echo "  start       Start the container"
        echo "  stop        Stop the container"
        echo "  restart     Restart the container"
        echo "  update      Pull latest code, rebuild, and restart"
        echo "  status      Show container health and status"
        echo "  logs        View container logs (pass -f to follow)"
        echo "  logs app    View structured app logs (pass -f to follow)"
        echo "  logs audit  View security audit trail (pass -f to follow)"
        echo "  logs search Search log files for a term"
        echo "  logs stats  Show log summary (sizes, startup time, errors)"
        echo "  preset      View or change the security preset"
        echo "  apikey      Configure your LLM API key"
        echo "  url         Print the gateway URL (with auth token)"
        echo "  uninstall   Remove Hard Shell (optional: path to instance)"
        echo "  help        Show this help"
        ;;
    *)
        fail "Unknown command: $cmd (run 'hard-shell help' for usage)"
        ;;
esac
